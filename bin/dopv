#!/usr/bin/env ruby

#
# DOPv command line client
#

require 'optparse'
require 'dopv'

ERROR = {
  :parse_error    => 1,
  :plan_error     => 2,
  :provider_error => 4,
  :unknown_error  => -1
}

options = {}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: dopv [options]'
  opts.on('-p', '--plan FILE', String, 'Specify a plan file to execute') { |file| options[:plan] = file }
  opts.on('-h', '--help', String, 'Display help') do
    puts opts
    exit
  end
end

ARGV << "-h" if ARGV.empty?
error_msg = error_code = nil
begin
  parser.parse!

  plan = Dopv::Plan.load(options[:plan])
  plan.execute
rescue OptionParser::ParseError => e
  error_msg   = e
  error_code  = ERROR[:parse_error]
rescue Dopv::Errors::PlanError => e
  error_msg   = e
  error_code  = ERROR[:plan_error]
rescue Dopv::Errors::ProviderError => e
  error_msg   = e
  error_code  =  ERROR[:provider_error]
rescue Exception => e
  error_msg   = e
  error_code  =  ERROR[:unknown_error]
end

STDERR.puts "ERROR: #{error_msg}" if error_msg
exit error_code if error_code
