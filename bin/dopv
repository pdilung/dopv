#!/usr/bin/env ruby

#
# DOPv command line client
#

require 'optparse'
require 'dopv'

ERROR = {
  :parse_error    => 1,
  :plan_error     => 2,
  :provider_error => 4,
  :unknown_error  => -1
}

options = {}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: dopv [options]'
  opts.on('-p', '--plan FILE', String, 'A FILE that holds a plan') { |file| options[:plan] = file }
  opts.on('-h', '--help', String, 'Display help') do
    puts opts
    exit
  end
end

ARGV << "-h" if ARGV.empty?
begin
  parser.parse!

  plan = Dopv::Plan.load(options[:plan])
  plan.execute
rescue OptionParser::ParseError => e
  STDERR.puts e
  exit ERROR[:parse_error]
rescue Dopv::Errors::PlanError => e
  STDERR.puts e
  exit ERROR[:plan_error]
rescue Dopv::Errors::ProviderError => e
  STDERR.puts e
  exit ERROR[:provider_error]
rescue Exception => e
  STDERR.puts e
  exit ERROR[:unknown_error]
end
